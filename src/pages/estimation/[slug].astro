---
import Base from '../../layouts/Base.astro';
import { COMMUNES, getCommuneBySlug, type Commune } from '../../data/communes';
import CityHero from '../../components/city/CityHero.astro';
import CityBenefits from '../../components/city/CityBenefits.astro';
import CitySteps from '../../components/city/CitySteps.astro';
import CityLocalContext from '../../components/city/CityLocalContext.astro';
import CitySEOContent from '../../components/city/CitySEOContent.astro';
import CityFAQ from '../../components/city/CityFAQ.astro';
import EstimationForm from '../../components/city/EstimationForm';
import CityNearby from '../../components/city/CityNearby.astro';

export const prerender = true;

export async function getStaticPaths() {
  return COMMUNES.map((commune) => ({
    params: { slug: commune.slug },
    props: { commune }
  }));
}

interface Props {
  commune: Commune;
}

const { commune } = Astro.props;
const { name, slug, zone, dept, meta, localContext, communesProches, marketStats, localScenarios } = commune;

// Canonical URL
const canonicalURL = new URL(`/estimation/${slug}`, Astro.site);

// Breadcrumbs JSON-LD
const breadcrumbsSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Accueil",
      "item": Astro.site?.toString()
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Zone d'intervention",
      "item": new URL('/zone-intervention', Astro.site).toString()
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": `Estimation ${name}`,
      "item": canonicalURL.toString()
    }
  ]
};

// Service Schema
const serviceSchema = {
  "@context": "https://schema.org",
  "@type": "Service",
  "serviceType": "Estimation immobilière",
  "provider": {
    "@type": "RealEstateAgent",
    "name": "L'Agence de Voglans",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "93 Chemin de la Combe",
      "addressLocality": "Voglans",
      "postalCode": "73420",
      "addressCountry": "FR"
    },
    "telephone": "+33757830262",
    "email": "contact@agencevoglans.fr"
  },
  "areaServed": {
    "@type": "City",
    "name": name,
    "containedInPlace": {
      "@type": "AdministrativeArea",
      "name": dept
    }
  },
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "EUR",
    "description": "Estimation immobilière gratuite et sans engagement"
  }
};

// localBusinessSchema supprimé - Base.astro gère déjà RealEstateAgent avec @graph
// serviceSchema suffit pour indiquer le service d'estimation avec provider référencé

// FAQ Schema - Optimise pour les featured snippets Google
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": `Combien de temps pour vendre un bien immobilier à ${name} ?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Le délai moyen de vente à ${name} varie selon le type de bien et le marché local. L'Agence de Voglans vous accompagne pour optimiser ce délai grâce à notre expertise locale et notre connaissance approfondie du marché immobilier en Savoie. Nous mettons en place une stratégie de vente personnalisée pour maximiser vos chances de vendre rapidement au meilleur prix.`
      }
    },
    {
      "@type": "Question",
      "name": `Quel est le prix moyen au m² à ${name} ?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Le prix moyen au m² à ${name} varie selon les quartiers, le type de bien (maison, appartement) et ses caractéristiques. Pour obtenir une estimation précise et personnalisée de votre bien immobilier à ${name}, contactez L'Agence de Voglans. Notre estimation est 100% gratuite, sans engagement, et vous recevrez un rapport détaillé sous 48h.`
      }
    },
    {
      "@type": "Question",
      "name": "L'estimation immobilière est-elle vraiment gratuite ?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Oui, notre estimation immobilière est 100% gratuite et sans aucun engagement. L'Agence de Voglans vous fournit un rapport d'estimation détaillé sous 48h, basé sur notre connaissance approfondie du marché local et des transactions récentes dans votre secteur."
      }
    },
    {
      "@type": "Question",
      "name": `Pourquoi choisir L'Agence de Voglans pour vendre à ${name} ?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `L'Agence de Voglans est une agence 100% locale et humaine, spécialisée dans l'immobilier en Savoie. Notre expertise du marché de ${name} et notre accompagnement personnalisé vous garantissent une vente optimisée. Nous proposons des honoraires transparents, un service digital moderne et une relation humaine de proximité.`
      }
    },
    {
      "@type": "Question",
      "name": "Comment se déroule une estimation immobilière ?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Notre processus d'estimation est simple : 1) Vous remplissez le formulaire en ligne avec les informations sur votre bien. 2) Nous analysons votre bien et le marché local. 3) Vous recevez votre estimation détaillée sous 48h. 4) Si vous le souhaitez, nous vous accompagnons dans votre projet de vente avec un suivi personnalisé."
      }
    }
  ]
};
---

<Base 
  title={meta.title}
  description={meta.description}
>
  <!-- SEO Meta Tags -->
  <Fragment slot="head">
    <link rel="canonical" href={canonicalURL} />
    <meta name="keywords" content={meta.keywords.join(', ')} />
    
    <!-- Open Graph -->
    <meta property="og:title" content={meta.title} />
    <meta property="og:description" content={meta.description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="fr_FR" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={meta.title} />
    <meta name="twitter:description" content={meta.description} />
    
    <!-- JSON-LD Schemas -->
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbsSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
    <!-- localBusinessSchema supprimé - Base.astro gère RealEstateAgent -->
    <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  </Fragment>

  <!-- Hero Section -->
  <CityHero name={name} zone={zone} />

  <!-- Preuves & Bénéfices -->
  <CityBenefits name={name} zone={zone} />

  <!-- Méthodologie -->
  <CitySteps name={name} zone={zone} />

  <!-- Contexte Local (SEO) -->
  <CityLocalContext 
    name={name} 
    zone={zone} 
    atouts={localContext.atouts}
    biens={localContext.biens}
  />

  {marketStats && (
    <section class="max-w-5xl mx-auto px-4 py-12">
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
        <p class="text-sm font-semibold text-primary uppercase tracking-widest mb-2">Chiffres clés 2025</p>
        <h2 class="text-3xl font-bold text-gray-900 mb-6">
          {name} : les indicateurs marché à connaître
        </h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="p-5 rounded-xl bg-slate-50 border border-slate-100">
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2">Maisons</h3>
            <p class="text-lg text-gray-900 leading-relaxed">{marketStats.priceHouse}</p>
          </div>
          <div class="p-5 rounded-xl bg-slate-50 border border-slate-100">
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2">Appartements</h3>
            <p class="text-lg text-gray-900 leading-relaxed">{marketStats.priceApartment}</p>
          </div>
          <div class="p-5 rounded-xl bg-slate-50 border border-slate-100">
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2">Demande acheteurs</h3>
            <p class="text-lg text-gray-900 leading-relaxed">{marketStats.demand}</p>
          </div>
          <div class="p-5 rounded-xl bg-slate-50 border border-slate-100">
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-2">Délai moyen</h3>
            <p class="text-lg text-gray-900 leading-relaxed">{marketStats.delai}</p>
          </div>
        </div>
      </div>
    </section>
  )}

  {localScenarios && localScenarios.length > 0 && (
    <section class="max-w-5xl mx-auto px-4 py-12">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-sm font-semibold uppercase tracking-widest text-primary">Cas concrets</span>
        <span class="text-xs text-gray-400">Insights terrain</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-900 mb-6">
        Résultats obtenus récemment à {name}
      </h2>
      <div class="grid md:grid-cols-2 gap-6">
        {localScenarios.map((scenario) => (
          <article class="h-full bg-white border border-gray-100 rounded-2xl shadow-sm p-6 flex flex-col">
            <div>
              <p class="text-sm font-semibold text-primary uppercase tracking-wide mb-2">
                {scenario.title}
              </p>
              <p class="text-lg font-semibold text-gray-900 mb-3">{scenario.result}</p>
            </div>
            <p class="text-sm text-gray-600 mt-auto bg-slate-50 border border-slate-100 rounded-xl p-4">
              <span class="font-semibold text-gray-900">Le secret :</span> {scenario.lesson}
            </p>
          </article>
        ))}
      </div>
    </section>
  )}

  <!-- SEO Content -->
  <CitySEOContent name={name} seoContent={commune.seoContent} />

  <!-- FAQ -->
  <CityFAQ 
    name={name} 
    communesProches={communesProches}
    allCommunes={COMMUNES}
  />

  <!-- Formulaire d'estimation (React Island) -->
  <EstimationForm client:visible cityName={name} />

  <!-- Communes proches (Interliens) -->
  <CityNearby 
    communesProches={communesProches}
    allCommunes={COMMUNES}
    currentSlug={slug}
  />
</Base>
